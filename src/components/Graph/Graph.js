import React from "react";
import axios from 'axios';
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  Title,
  Tooltip,
  Legend
} from "chart.js";
import { Line, Bar } from "react-chartjs-2";
import { GraphGrid, GraphCell } from './Graph.style';
import { timeConverter } from '../../util/numberUtil';

ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  Title,
  Tooltip,
  Legend
);

export const lineOptions = {
  responsive: true,
  plugins: {
    legend: {
      position: "top",
    },
    title: {
      display: true,
      text: "Graph Name",
    },
  },
  scales: {
    yAxis: {
      axis: "y",
      display: false,
      },
    xAxis: {
      axis: "x",
      grid: {
        display: false,
        drawTicks: false,
        borderWidth: 0,
      },
      ticks: {
        maxRotation: 0,
        minRotation: 0,
        // callback: function (value, index) {
        //   return global[index].slice(3, 5)
        // },
        autoSkip: true,
        maxTicksLimit: 15,
      },
    },
  },
};

export const barOptions = {
  responsive: true,
  plugins: {
    legend: {
      position: "top",
    },
    title: {
      display: true,
      text: "Graph Name",
    },
  },
  scales: {
    yAxis: {
      axis: "y",
      display: false,
      },
    xAxis: {
      axis: "x",
      grid: {
        display: false,
        drawTicks: false,
        borderWidth: 0,
      },
    },
  },
};

export default class Graph extends React.Component {

  state ={
    graph: null,
    labels: [],
    prices: [],
    volumeLabels: [],
    volumePrices: [],
    days: 12,
    isLoading: false,
    hasError: false
  }

  getGraphData = async () => {
    try {
      this.setState({ isLoading: true });
      const { data } = await axios(
        `https://api.coingecko.com/api/v3/coins/${this.props.cryptoName}/market_chart?vs_currency=${this.props.currencyName}&days=${this.state.days}`
        // `https://api.coingecko.com/api/v3/coins/${this.props.cryptoName}/market_chart/range?vs_currency=${this.props.currencyName}&from=1637366400000&to=1652906721000`
      );
      const { labels, prices } = data.prices.reduce((acc, [label, price]) => ({
          labels: [...acc.labels, timeConverter(label)],
          prices: [...acc.prices, price]
        }), {labels: [], prices:[]});
      
      const { volumeLabels, volumePrices } = data.total_volumes.reduce((acc, [label, price]) => ({
        volumeLabels: [...acc.volumeLabels, timeConverter(label)],
        volumePrices: [...acc.volumePrices, price]
      }), {volumeLabels: [], volumePrices:[]});
  
      this.setState({
        labels,
        prices,
        volumeLabels,
        volumePrices
      })
    } catch (err) {
      console.log("Location Error:", err);
    }
  };

  componentDidUpdate(prevProps, prevState) {
    if (this.props.currencyName !== prevProps.currencyName) {
      this.getGraphData();
    }
    if (this.props.cryptoName !== prevProps.cryptoName) {
      this.getGraphData();
    }
    if (this.state.days !== prevState.days) {
      this.getGraphData();
    }
  }
  
  componentDidMount() {
    this.getGraphData();
  }

  formatData = (label, price) => {
    return {
      labels: label,
      datasets: [
        {
          data: price,
          borderColor: "rgb(53, 162, 235)",
          backgroundColor: "rgba(53, 162, 235, 0.5)"
        }
      ]
    }
  }
  
  hasData = () =>  this.state.labels.length && this.state.prices.length;

  render() {

    const { labels, volumeLabels, isLoading } = this.state;
    const hasGraph = !isLoading && labels.length && volumeLabels.length;
    const priceData = this.formatData(this.state.labels, this.state.prices);
    const volumeData = this.formatData(this.state.volumeLabels, this.state.volumePrices);
    lineOptions.plugins.title.text = (this.props.cryptoName === 'bitcoin') ? 'BTC' : 'ETH';
    barOptions.plugins.title.text = (this.props.cryptoName === 'bitcoin') ? 'BTC Volume' : 'ETH Volume';


    return (
      <>
        {isLoading && <div>Loading...</div>}
        {hasGraph && this.hasData() && (
          <GraphGrid>
            <GraphCell>
              <Line options={lineOptions} data={priceData} />
            </GraphCell>
            <GraphCell>
              <Bar options={barOptions} data={volumeData} />
            </GraphCell>
          </GraphGrid>
        )} 
      </>
    );
  }

};

// const priceTest = [[1653192219734,29398.40600165276],[1653192598939,29391.652768406315],[1653192885211,29396.5684418707],[1653193146747,29390.41323466775],[1653193514572,29366.65560354388],[1653193778235,29377.92736550821],[1653194050526,29358.874642621366],[1653194390636,29365.684155999552],[1653194670109,29358.912150561657],[1653194914578,29371.18198679285],[1653195286166,29375.423374118855],[1653195548740,29348.146110206842],[1653195821358,29349.316745181754],[1653196230060,29374.71291986218],[1653196503558,29382.843082151023],[1653196775920,29383.408901437942],[1653197061998,29356.23098899735],[1653197335986,29418.352018410802],[1653197613471,29434.58265944526],[1653197994466,29434.88258444672],[1653198296203,29425.363027262636],[1653198573551,29446.44691813039],[1653198862407,29422.03141482046],[1653199132777,29421.371906529017],[1653199413555,29431.952710958874],[1653199827824,29410.575711297435],[1653200096901,29414.724925647384],[1653200387123,29429.294812026168],[1653200660221,29419.407865083682],[1653200910319,29420.212850634904],[1653201301262,29442.503165046637],[1653201550696,29448.944770144917],[1653201804036,29441.95622148842],[1653202199796,29445.38606357188],[1653202492266,29436.55117478625],[1653202765705,29440.270841599387],[1653203075487,29447.003036995808],[1653203340415,29438.323812946182],[1653203607431,29434.0183618908],[1653204018159,29437.12012036762],[1653204285243,29435.22286290721],[1653204562638,29437.266285207286],[1653204842870,29418.92391562176],[1653205084202,29436.92197706375],[1653205507975,29419.967172226192],[1653205791367,29444.67057691058],[1653206073519,29466.145099640733],[1653206324998,29465.85503423404],[1653206622554,29477.218843260835],[1653207012109,29478.58354961666],[1653207285202,29475.61139853296],[1653207572179,29482.670232975997],[1653207866373,29475.919225800797],[1653208148463,29490.26339677667],[1653208447780,29489.216919153972],[1653208733394,29522.407781562986],[1653209113696,29527.34541890845],[1653209239631,29531.59295591334],[1653209594492,29574.294644900077],[1653209913817,29577.488869025095],[1653210201298,29592.234284300295],[1653210624723,29582.96303724895],[1653210781040,29595.178744626843],[1653211199357,29600.10656563221],[1653211438629,29584.069015568788],[1653211752969,29597.34329528681],[1653212091425,29683.237442302372],[1653212412136,29852.389164280252],[1653212684836,29973.129029235537],[1653212957734,29954.324515703072],[1653213248820,29967.843060065756],[1653213503830,30025.810045074377],[1653213788110,30127.69838105713],[1653214198850,30160.49178540561],[1653214492089,30158.450314953494],[1653214763409,30188.93660023941],[1653215064758,30169.74335561078],[1653215344049,30195.25685123799],[1653215626416,30236.56453470675],[1653215992333,30211.36804755491],[1653216253948,30222.291460006636],[1653216618686,30268.607450036907],[1653216889716,30277.692954290498],[1653217145635,30236.777415095316],[1653217415466,30229.25526840718],[1653217798639,30259.018616846257],[1653218082681,30248.12382281336],[1653218334530,30240.267100855468],[1653218602399,30242.64186104426],[1653218975778,30181.054487795394],[1653219261413,30100.846635783826],[1653219512802,30088.316552167937],[1653219905691,29971.808806797202],[1653220167303,29956.57921350097],[1653220422796,29951.02687091464],[1653220787963,29919.258535544526],[1653221081133,29945.527254125584],[1653221371563,29974.179916553094],[1653221635098,29980.481213508323],[1653222026138,30003.47511032297],[1653222308287,30091.598905726994],[1653222577297,30188.79736966932],[1653222866595,30117.269134622868],[1653223130336,30129.89132793425],[1653223408861,30128.69508031534],[1653223808140,30139.459818319607],[1653224094547,30154.535284503978],[1653224365160,30195.853504758594],[1653224650588,30165.697282393456],[1653224927578,30160.861496575795],[1653225192303,30153.18028396949],[1653225582821,30102.507038206844],[1653225829601,30104.3323516115],[1653226179468,30109.396349462597],[1653226460331,30089.94582168369],[1653226811856,30093.78397408533],[1653227070984,30077.393490503797],[1653227319510,30072.035192487165],[1653227692536,30041.304776405053],[1653227956365,30059.79716769435],[1653228236692,30098.46736457866],[1653228508620,30108.11942630962],[1653228780367,30015.19377752947],[1653229171162,30018.457110424966],[1653229448366,30015.053854611062],[1653229711905,30042.891698488776],[1653230109313,30021.778556870267],[1653230389273,30016.46642309779],[1653230651110,30033.981829794717],[1653230940542,30017.213061021965],[1653231193255,29991.026686989168],[1653231586627,30009.759324959436],[1653231878249,30018.553640852675],[1653232174261,29957.64574812416],[1653232465257,29958.154226433042],[1653232736411,29937.603401845394],[1653233031555,29854.289032547047],[1653233399086,29836.45526773627],[1653233696092,29788.702932410855],[1653233969983,29804.715504547803],[1653234246741,29810.420695609908],[1653234588482,29836.327449981873],[1653234863586,29882.464591750657],[1653235214231,29888.987158689626],[1653235517624,29933.40224924074],[1653235802822,29909.1259225975],[1653236084611,29883.410683312384],[1653236351636,29838.469612027297],[1653236635103,29867.330542678665],[1653236990095,29881.259672614342],[1653237259655,29892.828428323457],[1653237607799,29938.46359511356],[1653237872719,29929.4515432145],[1653238102709,29928.73034624339],[1653238490966,29928.423587996327],[1653238754378,29958.666956261368],[1653239017825,29951.95585857969],[1653239395776,30006.808976180877],[1653239674066,30028.913386052085],[1653240043258,30011.06978776242],[1653240175250,30099.418850923757],[1653240579283,30144.941973556313],[1653240882572,30104.885456955097],[1653241120448,30071.990762620662],[1653241503753,30052.639339606252],[1653241784277,30026.160623886364],[1653242016425,30012.7544654265],[1653242372956,29978.384670416777],[1653242678549,29960.30409245645],[1653242955891,29969.532576469883],[1653243199765,29958.343848277273],[1653243595633,29949.251174381938],[1653243867886,29930.256018119468],[1653244103682,29964.923052723705],[1653244502605,29999.208741344664],[1653244762469,30027.842355390443],[1653244997706,30017.707308723795],[1653245338613,30028.31959482965],[1653245603562,30022.801642545004],[1653245967406,30049.27974428577],[1653246239258,30058.514390646902],[1653246593824,30056.56633634051],[1653246863261,30035.823812347993],[1653247114651,30043.060454872135],[1653247518024,30056.62367280671],[1653247758488,30046.083320503505],[1653248122876,30033.399189674226],[1653248392153,30030.24718589713],[1653248672093,30043.177644458887],[1653248964878,30024.232912761276],[1653249209116,29993.69152824562],[1653249575838,29976.10252024696],[1653249887215,29977.610696367425],[1653250169341,29955.265575377583],[1653250456898,29979.107102570288],[1653250714177,29996.36499643421],[1653251121427,30009.848763555117],[1653251261769,30025.92139664368],[1653251674824,30076.22637605446],[1653251947929,30063.723280061036],[1653252310815,30045.85089817729],[1653252550733,30048.84779380521],[1653252913390,30028.505129816374],[1653253146483,29974.13309415041],[1653253421521,29963.02819631582],[1653253805234,29962.62961740394],[1653254071035,29983.748556497114],[1653254398149,29990.582100234507],[1653254670987,30016.239072788012],[1653255049429,30009.234473369397],[1653255316210,30029.785374292635],[1653255577681,30049.942166614146],[1653255850742,30038.34071383075],[1653256211238,30078.920304662523],[1653256473484,30071.67360307364],[1653256737600,30069.910565295708],[1653256998967,30119.556777631344],[1653257377095,30167.99044478114],[1653257670849,30167.63346761232],[1653257933073,30193.23963618515],[1653258307801,30315.66597986464],[1653258567249,30275.412607942595],[1653258829387,30321.717939207996],[1653259182709,30330.81108125665],[1653259438386,30333.07271785835],[1653259799248,30319.85844782602],[1653260075938,30359.303533026075],[1653260330395,30341.531208439646],[1653260709716,30366.294256691897],[1653260987509,30399.653688306757],[1653261272409,30414.61640790098],[1653261534822,30415.35592556441],[1653261924416,30421.92326679254],[1653262189253,30451.59189931019],[1653262455913,30399.977973251993],[1653262726877,30373.520783919044],[1653263109248,30392.863489370102],[1653263362220,30384.079172118923],[1653263622773,30387.098858023448],[1653263973481,30351.050417138096],[1653264266621,30297.457558243867],[1653264507327,30327.22623491587],[1653264798712,30391.450218845814],[1653265203607,30374.744857078847],[1653265489406,30357.657117277835],[1653265752131,30311.320213781117],[1653266064387,30300.736281399706],[1653266439426,30300.38480890905],[1653266699029,30298.665900286258],[1653266978046,30291.395079237387],[1653267276254,30296.1166822327],[1653267519626,30300.123520864105],[1653267915296,30262.63701099878],[1653268198972,30230.068283437573],[1653268469699,30253.54104409233],[1653268745659,30242.55002919345],[1653269110454,30231.340070263086],[1653269432257,30247.096468706844],[1653269685779,30257.553187334885],[1653270018198,30259.571169896608],[1653270362739,30231.25633576779],[1653270598019,30234.11900711185],[1653270935836,30226.804087558994],[1653271180578,30233.304059660284],[1653271450768,30238.52753297782],[1653271857778,30195.168828138747],[1653272106167,30156.64220976139],[1653272380283,30155.719172319634],[1653272797024,30165.062304351908],[1653273049010,30150.669582971706],[1653273344321,30130.5597385977],[1653273603618,30098.252728553773]];
// function printDate() {
//   priceTest.map((array) => {
//     console.log(timeConverter(array[0]));
//   })
// }

// printDate();